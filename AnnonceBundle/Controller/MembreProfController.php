<?phpnamespace Tuni\AnnonceBundle\Controller;use Symfony\Component\HttpFoundation\Request;use Symfony\Bundle\FrameworkBundle\Controller\Controller;use Sensio\Bundle\FrameworkExtraBundle\Configuration\Method;use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;use Tuni\AdminBundle\Entity\Membre;use Tuni\AdminBundle\Entity\Utilisateur;use Tuni\AdminBundle\Entity\StatutMembre;use Tuni\AdminBundle\Form\MembreProfType;use Tuni\AdminBundle\Form\MembreProEditfType;use Tuni\AdminBundle\Form\UtilisateurType;use Symfony\Component\HttpFoundation\Response;/** * Membre controller. * * @Route("/membreProf") */class MembreProfController extends Controller{    /**     * Lists all Membre entities.     *     * @Route("/", name="tuni_membreProf")     * @Method("GET")     * @Template()     */    public function indexAction()    {        $em = $this->getDoctrine()->getManager();        $query = $em->createQueryBuilder();        $idp=$query->select('a.id')              ->from('TuniAdminBundle:StatutMembre', 'a')              ->where($query->expr()->like('a.statut', $query->expr()->literal('%Prof%')))              ->getQuery()              ->getSingleScalarResult();        $query2 = $em->createQueryBuilder();        $query2->select('a')              ->from('TuniAdminBundle:Membre', 'a')              ->where("a.statutMembre = $idp")              ->getQuery();               $paginator  = $this->get('knp_paginator');    $pagination = $paginator->paginate(        $query2,        $this->get('request')->query->get('page', 1)/*page number*/,        10/*limit per page*/    );    $total = $query2->select('COUNT(a)')                    ->getQuery()                    ->getSingleScalarResult();    // parameters to template      return $this->render('TuniAdminBundle:MembreProf:listeMembre.html.twig',array('page'=>'prof_Member','pagination' => $pagination,'total' => $total));        }    /**     * Creates a new Membre entity.     *     * @Route("/create", name="tuni_membreProf_create")     * @Method("POST")     * @Template("TuniAdminBundle:MembreProf:new.html.twig")     */    public function createAction(Request $request)    {   $Utilisateur = new Utilisateur();        $formUtilisateur     = $this->createForm(new UtilisateurType(), $Utilisateur);        $entity  = new Membre();        $form = $this->createForm(new MembreProfType(), $entity);        $form->bind($request);        $formUtilisateur->bind($request);                if ($form->isValid()) {            $em = $this->getDoctrine()->getManager();            $Utilisateur->setRoles(array('ROLE_PROFESSIONNEL'));                         $userManager = $this->container->get('fos_user.user_manager');                         $usertemp = $userManager->createUser();                                                 $usertemp->setRoles($Utilisateur->getRoles());                         $usertemp->setUsername($Utilisateur->getUsername());                         $usertemp->setEmail($Utilisateur->getEmail());                         $usertemp->setPlainPassword($Utilisateur->getPassword());//                         $usertemp->setLocked(FALSE);                         $usertemp->setEnabled(TRUE);//                         $usertemp->setCredentialsExpired(FALSE);//                                                  $userManager->updateUser($usertemp);                         $repository = $this->getDoctrine()                                        ->getEntityManager()                                        ->getRepository('TuniAdminBundle:Utilisateur');                          $utilisateurCree=$repository->findOneBy(array('email' => $Utilisateur->getEmail()));            $entity->setUtilisateur($utilisateurCree);             $repositoryStatutMembre = $this->getDoctrine()                                        ->getEntityManager()                                        ->getRepository('TuniAdminBundle:StatutMembre');                          $StatutMembre=$repositoryStatutMembre->findOneBy(array('statut' =>'Professionnel'));                        $entity->setStatutMembre($StatutMembre);                        $d = new \DateTime('now');            $z = $d->format('Y-m-d H:i:s');            if($entity->getLogo()!=NULL)            $entity->uploadImage();                        $entity->setRegistredUser($d);            $em->persist($entity);            $em->flush();            $this->get('session')->setFlash(                                                    'notice',                                                     'Le membre a été modifié avec succée'                                                  );               $this->container->get('fos_user.security.login_manager')->loginUser(                $this->container->getParameter('fos_user.firewall_name'),                $usertemp,                NULL);            return $this->redirect($this->generateUrl('tuni_annonce_homepage'));        }        return array(            'entity' => $entity,            'form'   => $form->createView(),            'page'=>'prof_Member'        );    }    /**     * Displays a form to create a new Membre entity.     *     * @Route("/new", name="tuni_membreProf_new")     * @Method("GET")     * @Template()     */    public function newAction()    {        $entity = new Membre();        $formMembre   = $this->createForm(new MembreProfType(), $entity);        $Utilisateur = new Utilisateur();        $form     = $this->createForm(new UtilisateurType(), $Utilisateur);return  array_merge($this->init(), array(            'entity' => $entity,            'form'   => $form->createView(),            'formMembre' => $formMembre->createView(),            'page'=>'prof_Member'        ));                    }    /**     * Finds and displays a Membre entity.     *     * @Route("/{id}/show", name="tuni_membreProf_show")     * @Method("GET")     * @Template()     */    public function showAction($id)    {        $em = $this->getDoctrine()->getManager();        $entity = $em->getRepository('TuniAdminBundle:Membre')->find($id);        if (!$entity) {            throw $this->createNotFoundException('Unable to find Membre entity.');        }        $deleteForm = $this->createDeleteForm($id);        return array(            'entity'      => $entity,            'delete_form' => $deleteForm->createView(),            'page'=>'prof_Member'        );    }    /**     * Displays a form to edit an existing Membre entity.     *     * @Route("/{id}/edit", name="tuni_membreProf_edit")     * @Method("GET")     * @Template()     */    public function editAction($id)    {        $em = $this->getDoctrine()->getManager();        $entity = $em->getRepository('TuniAdminBundle:Membre')->find($id);        if (!$entity) {            throw $this->createNotFoundException('Unable to find Membre entity.');        }        $Utilisateur = $entity->getUtilisateur();        $form     = $this->createForm(new UtilisateurType(), $Utilisateur);        $editForm = $this->createForm(new MembreProEditfType(), $entity);        $deleteForm = $this->createDeleteForm($id);        return array(            'entity'      => $entity,            'edit_form'   => $editForm->createView(),            'form'   => $form->createView(),            'delete_form' => $deleteForm->createView(),            'page'=>'prof_Member'        );    }    /**     * Edits an existing Membre entity.     *     * @Route("/{id}/update", name="tuni_membreProf_update")     * @Method("POST")     * @Template("TuniAdminBundle:MembreProf:edit.html.twig")     */    public function updateAction(Request $request, $id)    {        $em = $this->getDoctrine()->getManager();        $entity = $em->getRepository('TuniAdminBundle:Membre')->find($id);         if (!$entity) {            throw $this->createNotFoundException('Unable to find Membre entity.');        }        $oldlogo=$entity->getLogo();               $deleteForm = $this->createDeleteForm($id);        $editForm = $this->createForm(new MembreProEditfType(), $entity);        $editForm->bind($request);        $Utilisateur = new Utilisateur();        $form     = $this->createForm(new UtilisateurType(), $Utilisateur);        $form->bind($request);        $email=  $Utilisateur->getEmail();        $user = $entity->getUtilisateur();	$username=  $user->getUsernameCanonical();        $ancienMdp = $user->getPassword();	//$editUserForm = $this->createForm(new UtilisateurType(), $user);	        $query = $em->createQuery('SELECT a.id FROM TuniAdminBundle:Utilisateur a WHERE a.id <> '.$user->getId().' AND ( a.email =\''.$email.'\' OR a.username =\''.$Utilisateur->getUsername().'\' )');    	$resultats = $query->getResult();            //var_dump($resultats);        if(count($resultats))	  {  $this->get('session')->setFlash(            'notice',           ' ERREUR ,Compte existe déjas avec l\'email '.$Utilisateur->getEmail().' ou le nom d\'utlisateur '.$Utilisateur->getUsername().' ! '        );        return $this->editAction($id);          } 	// gestion du changement -ou non- de mot de passe		$isNewPassword = ($Utilisateur->getPassword()== '')? false : true ;	if(!$isNewPassword){		// réinjection de l'ancien mot de passe dans la requête		$user->setPassword($ancienMdp);	}	        if ($editForm->isValid()) {                                    $userManager = $this->container->get('fos_user.user_manager');                         $usertemp = $userManager->findUserByUsernameOrEmail($username);                                                 $usertemp->setUsername($Utilisateur->getUsername());                         $usertemp->setEmail($Utilisateur->getEmail());		if($isNewPassword){			                         $usertemp->setPlainPassword($Utilisateur->getPassword());                                        }                $userManager->updateUser($usertemp);                if(!$isNewPassword){                                $em->persist($user);                $em->flush();                                }                if($entity->getLogo()!=NULL){                    if($oldlogo!=NULL)                        $entity->removeOldImage($oldlogo);                    $entity->uploadImage();                }                else {                    if($oldlogo!=NULL)                        $entity->setLogo($oldlogo);                }            $em->persist($entity);            $em->flush();            $this->get('session')->setFlash(                                                    'notice',                                                     'Le membre a été modifié avec succée'                                                  );            //return $this->redirect($this->generateUrl('membreProf_edit', array('id' => $id)));            return $this->redirect($this->generateUrl('membreProf'));        }         $this->get('session')->setFlash(            'notice',            ' ERREUR ,Veuillez saisir de nouveau les coordonées du membre ! '        );        return array(            'entity'      => $entity,            'edit_form'   => $editForm->createView(),            'form'   => $form->createView(),            'delete_form' => $deleteForm->createView(),            'page'=>'particular_Member'        );    }    /**     * Deletes a Membre entity.     *     * @Route("/{id}/delete", name="tuni_membreProf_delete")     * @Method("GET")     */    public function deleteAction(Request $request, $id)    {                   $em = $this->getDoctrine()->getManager();            $entity = $em->getRepository('TuniAdminBundle:Membre')->find($id);            $this->get('session')->setFlash(            'notice',            ' ERREUR de supprission du membre ! '        );            if (!$entity) {                throw $this->createNotFoundException('Unable to find Membre entity.');            }            //var_dump($entity);            $em->remove($entity->getUtilisateur());            $em->remove($entity);            $em->flush();            $this->get('session')->setFlash(                                                    'notice',                                                     'Le membre a été supprimé avec succée'                                                  );                       return $this->redirect($this->generateUrl('membre'));    }    /**     * Creates a form to delete a Membre entity by id.     *     * @param mixed $id The entity id     *     * @return Symfony\Component\Form\Form The form     */    private function createDeleteForm($id)    {        return $this->createFormBuilder(array('id' => $id))            ->add('id', 'hidden')            ->getForm()        ;    }     public function init()    {                $em = $this->getDoctrine()->getManager();        $repository = $this->getDoctrine()                                        ->getManager()                                        ->getRepository('TuniAnnonceBundle:Temoignage');                          $Temoignages=$repository->findBy(array('isPublier' => TRUE));            $Categories = $em->getRepository('TuniAnnonceBundle:Categorie')->findAll();                 $SousCategories = $em->getRepository('TuniAnnonceBundle:SousCategorie')->findAll();              $query = $em->createQuery("    SELECT a    FROM TuniAnnonceBundle:Annonce a    ORDER BY a.id DESC    ");$query->setMaxResults(20);        $lastAnnonces = $query                    ->getResult();                                          $membre = NULL;            if ($this->get('security.context')->isGranted('ROLE_USER')) {                //User is logged in                    $user = $this->container->get('security.context')->getToken()->getUser();                $id = $user->getId();                $membre = $em->getRepository('TuniAnnonceBundle:Membre')->findOneBy(array('utilisateur' => $id));            }            return array('membre' => $membre,'Categories'=>$Categories,                                                                                        'SousCategories'=>$SousCategories,                                                                                        'Temoignages'=>$Temoignages,                                                                                         'lastAnnonces'=>$lastAnnonces                                                                                            );    }}